// hoodie.admin.js - 0.2.0
// https://github.com/hoodiehq/hoodie.admin.js
// Copyright 2012, 2013 https://github.com/hoodiehq/
// Licensed Apache License 2.0

(function(global) {
'use strict'

!function(a){"object"==typeof exports?module.exports=a():"function"==typeof define&&define.amd?define(a):"undefined"!=typeof window?window.HoodieAdmin=a():"undefined"!=typeof global?global.HoodieAdmin=a():"undefined"!=typeof self&&(self.HoodieAdmin=a())}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){function c(a){if("string"==typeof a&&(a={message:a}),!a.message)throw new Error("FATAL: error.message must be set");a.name||(a.name="HoodieError"),a.message=a.message.replace(d,function(b){var c=b.match(e)[0];return a[c]}),$.extend(this,a)}var d=/\{\{\s*\w+\s*\}\}/g,e=/\w+/;c.prototype=new Error,c.prototype.constructor=c,b.exports=c},{}],2:[function(a,b){function c(a){return a.name="HoodieObjectIdError",a.message='"{{id}}" is invalid object id. {{rules}}.',new d(a)}var d=a("../error"),e=/^[a-z0-9\-]+$/;c.isInvalid=function(a,b){return!(b||e).test(a||"")},c.isValid=function(a,b){return(b||e).test(a||"")},c.prototype.rules="Lowercase letters, numbers and dashes allowed only. Must start with a letter",b.exports=c},{"../error":1}],3:[function(a,b){function c(a){return a.name="HoodieObjectTypeError",a.message='"{{type}}" is invalid object type. {{rules}}.',new d(a)}var d=a("../error"),e=/^[a-z$][a-z0-9]+$/;c.isInvalid=function(a,b){return!(b||e).test(a||"")},c.isValid=function(a,b){return(b||e).test(a||"")},c.prototype.rules="lowercase letters, numbers and dashes allowed only. Must start with a letter",b.exports=c},{"../error":1}],4:[function(a,b){function c(a,b){function c(b,c){var d,e,f,g;for(d=b.split(" "),f=0,g=d.length;g>f;f++)e=h+d[f],a.eventsCallbacks[e]=a.eventsCallbacks[e]||[],a.eventsCallbacks[e].push(c)}function d(b,c){b=h+b;var d=function(){a.unbind(b,d),c.apply(null,arguments)};a.bind(b,d)}function e(){var b,c,d,e,f,g;if(b=1<=arguments.length?Array.prototype.slice.call(arguments,0):[],d=b.shift(),d=h+d,e=a.eventsCallbacks[d]){for(f=0,g=e.length;g>f;f++)c=e[f],c.apply(null,b);return!0}}function f(b,c){var d,e,f,g,i,j;if(!b)return h||(a.eventsCallbacks={}),j=Object.keys(a.eventsCallbacks),j=j.filter(function(a){return 0===a.indexOf(h)}),void j.forEach(function(b){delete a.eventsCallbacks[b]});if(b=h+b,f=a.eventsCallbacks[b]){if(!c)return void delete a.eventsCallbacks[b];for(e=g=0,i=f.length;i>g;e=++g)if(d=f[e],d===c){f=f.slice(),f.splice(e,1),a.eventsCallbacks[b]=f;break}}}var g=a,h="";b=b||{},a.eventsCallbacks||(a.eventsCallbacks={}),b.context&&(g=b.context,h=b.namespace+":"),g.bind=c,g.on=c,g.one=d,g.trigger=e,g.unbind=f,g.off=f}b.exports=c},{}],5:[function(a,b){function c(a){function b(b,c){return c=c||{},$.extend(c,{name:b}),d(a,c)}a.open=b}var d=a("./remote_store");b.exports=c},{"./remote_store":7}],6:[function(a,b){function c(a){function b(a){return!(!a||"function"!=typeof a.done||"function"==typeof a.resolve)}function c(){return h().resolve().promise()}function e(){return h().reject().promise()}function f(){var a=h();return a.resolve.apply(a,arguments).promise()}function g(a){var b=h(),c=new d(a);return b.reject(c).promise()}var h=window.jQuery.Deferred;a.defer=h,a.isPromise=b,a.resolve=c,a.reject=e,a.resolveWith=f,a.rejectWith=g}var d=a("./error");b.exports=c},{"./error":1}],7:[function(a,b){function c(a,b){function c(a){return"function"==typeof u?u(a):u=a}function e(a){var b,c;c=$.extend({},a);for(b in c)if(c.hasOwnProperty(b)){if(-1!==A.indexOf(b))continue;if(!/^_/.test(b))continue;delete c[b]}return c._id=""+c.type+"/"+c.id,r.prefix&&(c._id=""+r.prefix+c._id),delete c.id,c}function f(a){var b,c,d;return b=a._id||a.id,delete a._id,r.prefix&&(b=b.replace(t,"")),d=b.match(/([^\/]+)\/(.*)/),c=d[0],a.type=d[1],a.id=d[2],a}function g(a){var b,c,d,e;for(e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(f(b));return e}function h(a){var b,c,d,e;try{e=a._rev.split(/-/),c=e[0],b=e[1]}catch(f){}return c=parseInt(c,10)||0,d=i(),a._$local&&(d+="-local"),a._rev=""+(c+1)+"-"+d,a._revisions={start:1,ids:[d]},b?(a._revisions.start+=c,a._revisions.ids.push(b)):void 0}function i(){return a.generateId(9)}function j(a){return a.rows.map(function(a){return a.doc})}function k(){var a;return a=r.getSinceNr(),r.isConnected()&&!v?"/_changes?include_docs=true&since="+a+"&heartbeat=10000&feed=longpoll":"/_changes?include_docs=true&since="+a}function l(){w&&w.abort()}function m(a){return c(a.last_seq),p(a.results),r.isConnected()?r.pull():void 0}function n(b,c){if(r.isConnected())switch(b.status){case 401:return r.trigger("error:unauthenticated",c),r.disconnect();case 404:return window.setTimeout(r.pull,3e3);case 500:return r.trigger("error:server",c),window.setTimeout(r.pull,3e3),a.checkConnection();default:return"abort"===b.statusText?r.pull():(window.setTimeout(r.pull,3e3),a.checkConnection())}}function o(){v=!1,r.trigger("bootstrap:end")}function p(a){var b,c,d,e,g;for(e=0,g=a.length;g>e;e++)if(b=a[e].doc,!r.prefix||0===b._id.indexOf(r.prefix)){if(d=f(b),d._deleted){if(!r.isKnownObject(d))continue;c="remove",r.isKnownObject(d)}else r.isKnownObject(d)?c="update":(c="add",r.markAsKnownObject(d));r.trigger(c,d),r.trigger(c+":"+d.type,d),r.trigger(c+":"+d.type+":"+d.id,d),r.trigger("change",c,d),r.trigger("change:"+d.type,c,d),r.trigger("change:"+d.type+":"+d.id,c,d)}}var q={};q.find=function(a,b){var c;return c=a+"/"+b,r.prefix&&(c=r.prefix+c),c="/"+encodeURIComponent(c),r.request("GET",c).then(f)},q.findAll=function(a){var b,c,d;switch(c="/_all_docs?include_docs=true",!0){case void 0!==a&&""!==r.prefix:d=r.prefix+a+"/";break;case void 0!==a:d=a+"/";break;case""!==r.prefix:d=r.prefix;break;default:d=""}return d&&(b=d.replace(/.$/,function(a){var b;return b=a.charCodeAt(0),String.fromCharCode(b+1)}),c=""+c+'&startkey="'+encodeURIComponent(d)+'"&endkey="'+encodeURIComponent(b)+'"'),r.request("GET",c).then(j).then(g)},q.save=function(b){var c;return b.id||(b.id=a.generateId()),b=e(b),c="/"+encodeURIComponent(b._id),r.request("PUT",c,{data:b})},q.remove=function(a,b){return r.update(a,b,{_deleted:!0})},q.removeAll=function(a){return r.updateAll(a,{_deleted:!0})};var r=d(a,{name:b.name,backend:{save:q.save,find:q.find,findAll:q.findAll,remove:q.remove,removeAll:q.removeAll}}),s=null;r.connected=!1,r.prefix="";var t=new RegExp("^");void 0!==b.name&&(s=b.name),void 0!==b.prefix&&(r.prefix=b.prefix,t=new RegExp("^"+r.prefix)),null!==b.baseUrl&&(r.baseUrl=b.baseUrl),r.request=function(b,c,d){return d=d||{},s&&(c="/"+encodeURIComponent(s)+c),r.baseUrl&&(c=""+r.baseUrl+c),d.contentType=d.contentType||"application/json",("POST"===b||"PUT"===b)&&(d.dataType=d.dataType||"json",d.processData=d.processData||!1,d.data=JSON.stringify(d.data)),a.request(b,c,d)},r.isKnownObject=function(a){var b=""+a.type+"/"+a.id;return void 0!==z[b]?z[b]:void 0},r.markAsKnownObject=function(a){var b=""+a.type+"/"+a.id;return z[b]=1,z[b]},r.connect=function(a){return a&&(s=a),r.connected=!0,r.trigger("connect"),r.bootstrap().then(function(){r.push()})},r.disconnect=function(){r.connected=!1,r.trigger("disconnect"),w&&w.abort(),y&&y.abort()},r.isConnected=function(){return r.connected};var u=b.since||0;r.getSinceNr=function(){return"function"==typeof u?u():u};var v=!1;r.bootstrap=function(){return v=!0,r.trigger("bootstrap:start"),r.pull().done(o)};var w,x;r.pull=function(){return w=r.request("GET",k()),r.isConnected()&&(window.clearTimeout(x),x=window.setTimeout(l,25e3)),w.done(m).fail(n)};var y;r.push=function(b){var c,d,f,g;if($.isArray(b)||(b=B()),0===b.length)return a.resolveWith([]);for(d=[],f=0,g=b.length;g>f;f++)c=$.extend(!0,{},b[f]),h(c),c=e(c),d.push(c);return y=r.request("POST","/_bulk_docs",{data:{docs:d,new_edits:!1}}),y.done(function(){for(var a=0;a<b.length;a++)r.trigger("push",b[a])}),y},r.sync=function(a){return r.push(a).then(r.pull)};var z={},A=["_id","_rev","_deleted","_revisions","_attachments"],B=function(){return[]};if(b.defaultObjectsToPush&&(B=$.isArray(b.defaultObjectsToPush)?function(){return b.defaultObjectsToPush}:b.defaultObjectsToPush),b.knownObjects)for(var C=0;C<b.knownObjects.length;C++)r.markAsKnownObject({type:b.knownObjects[C].type,id:b.knownObjects[C].id});return r}var d=a("./store");b.exports=c},{"./store":9}],8:[function(a,b){function c(a,b,c){var e=c.name||"store",f=c.type,g=c.id,h={};return g||(d(a,{context:h,namespace:e+":"+f}),h.save=function(a,c,d){return b.save(f,a,c,d)},h.add=function(a,c){return b.add(f,a,c)},h.find=function(a){return b.find(f,a)},h.findOrAdd=function(a,c){return b.findOrAdd(f,a,c)},h.findAll=function(a){return b.findAll(f,a)},h.update=function(a,c,d){return b.update(f,a,c,d)},h.updateAll=function(a,c){return b.updateAll(f,a,c)},h.remove=function(a,c){return b.remove(f,a,c)},h.removeAll=function(a){return b.removeAll(f,a)}),g&&(d(a,{context:h,namespace:e+":"+f+":"+g}),h.save=function(a,c){return b.save(f,g,a,c)},h.find=function(){return b.find(f,g)},h.update=function(a,c){return b.update(f,g,a,c)},h.remove=function(a){return b.remove(f,g,a)}),h.decoratePromises=b.decoratePromises,h.validate=b.validate,h}var d=a("./events");b.exports=c},{"./events":4}],9:[function(a,b){function c(a,b){function c(a){return $.extend(a,j)}var i={},j={hoodie:a},k=b.name||"store",l=function p(c,e){var f=$.extend(!0,{type:c,id:e},b);return d(a,p,f)};if(e(a,{context:l,namespace:k}),l.validate=b.validate,b.validate||(l.validate=function(a){if(!a)return new f({name:"InvalidObjectError",message:"No object passed."});if(g.isInvalid(a.type,n))return new g({type:a.type,rules:o});if(a.id)return h.isInvalid(a.id,n)?new h({id:a.id,rules:o}):void 0}),l.save=function(b,d,e,f){f=f?$.extend(!0,{},f):{};var g=$.extend(!0,{},e,{type:b,id:d}),h=l.validate(g,f||{});return h?a.rejectWith(h):c(i.save(g,f||{}))},l.add=function(a,b,c){return void 0===b&&(b={}),c=c||{},l.save(a,b.id,b,c)},l.find=function(a,b){return c(i.find(a,b))},l.findOrAdd=function(a,b,d){function e(){var c;return c=$.extend(!0,{id:b},d),l.add(a,c)}null===d&&(d={});var f=l.find(a,b).then(null,e);return c(f)},l.findAll=function(a,b){return c(i.findAll(a,b))},l.update=function(b,d,e,f){function g(c){var g,h,i;return h=$.extend(!0,{},c),"function"==typeof e&&(e=e(h)),e?(g=function(){var a=[];for(var b in e)if(e.hasOwnProperty(b)){if(i=e[b],c[b]!==i==!1)continue;h[b]=i,a.push(b)}return a}(),g.length||f?l.save(b,d,h,f):a.resolveWith(h)):a.resolveWith(c)}var h=l.find(b,d).then(g);return c(h)},l.updateOrAdd=function(a,b,d,e){function f(){var c=$.extend(!0,{},d,{id:b});return l.add(a,c,e)}var g=l.update(a,b,d,e).then(null,f);return c(g)},l.updateAll=function(b,d,e){var f;switch(e=e||{},!0){case"string"==typeof b:f=l.findAll(b);break;case a.isPromise(b):f=b;break;case $.isArray(b):f=a.defer().resolve(b).promise();break;default:f=l.findAll()}return f=f.then(function(a){var b,c;return $.isArray(a)||(a=[a]),c=function(){var c,f,g;for(g=[],c=0,f=a.length;f>c;c++)b=a[c],g.push(l.update(b.type,b.id,d,e));return g}(),$.when.apply(null,c)}),c(f)},l.remove=function(a,b,d){return c(i.remove(a,b,d||{}))},l.removeAll=function(a,b){return c(i.removeAll(a,b||{}))},l.decoratePromises=function(a){return $.extend(j,a)},!b.backend)throw new Error("options.backend must be passed");var m="save find findAll remove removeAll".split(" ");m.forEach(function(a){if(!b.backend[a])throw new Error("options.backend."+a+" must be passed.");i[a]=b.backend[a]});var n=/^[^\/]+$/,o="/ not allowed";return l}var d=a("./scoped_store"),e=a("./events"),f=a("./error"),g=a("./error/object_type"),h=a("./error/object_id");b.exports=c},{"./error":1,"./error/object_id":2,"./error/object_type":3,"./events":4,"./scoped_store":8}],10:[function(a,b){function c(a){var b=this;if(!(b instanceof c))throw new Error("usage: new HoodieAdmin(url);");a&&(b.baseUrl=a.replace(/\/+$/,"")),b.extend=function(a){a(b)},b.extend(e),b.extend(f),b.extend(g),d(c)}function d(a){for(var b=0;b<h.length;b++)h[b](a)}var e=a("../node_modules/hoodie/src/hoodie/events"),f=a("../node_modules/hoodie/src/hoodie/promises"),g=a("../node_modules/hoodie/src/hoodie/open"),h=[];c.extend=function(a){h.push(a)},b.exports=c},{"../node_modules/hoodie/src/hoodie/events":4,"../node_modules/hoodie/src/hoodie/open":5,"../node_modules/hoodie/src/hoodie/promises":6}]},{},[10])(10)});